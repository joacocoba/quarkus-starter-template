#!/bin/bash

# üöÄ Quick Development Server Launcher
# Usage: ./rd [port] [options]
# 
# Examples:
#   ./rd              # Start on port 8080 (default)
#   ./rd 9090         # Start on port 9090
#   ./rd 8080 --debug # Start with debug mode
#   ./rd --help       # Show help

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Default values
DEFAULT_PORT=8080
PORT=$DEFAULT_PORT
DEBUG_MODE=false
SHOW_HELP=false

# Parse arguments
while [[ $# -gt 0 ]]; do
  case $1 in
    --help|-h)
      SHOW_HELP=true
      shift
      ;;
    --debug|-d)
      DEBUG_MODE=true
      shift
      ;;
    --port|-p)
      PORT="$2"
      shift 2
      ;;
    [0-9]*)
      PORT="$1"
      shift
      ;;
    *)
      echo -e "${RED}Unknown option: $1${NC}"
      SHOW_HELP=true
      shift
      ;;
  esac
done

# Show help if requested
if [ "$SHOW_HELP" = true ]; then
  echo -e "${BLUE}üöÄ Quick Development Server Launcher${NC}"
  echo ""
  echo -e "${GREEN}Usage:${NC}"
  echo "  ./rd [port] [options]"
  echo ""
  echo -e "${GREEN}Examples:${NC}"
  echo "  ./rd              # Start on port 8080 (default)"
  echo "  ./rd 9090         # Start on port 9090"
  echo "  ./rd --port 8080  # Start on port 8080 (explicit)"
  echo "  ./rd --debug      # Start with debug logging"
  echo "  ./rd 9090 --debug # Start on port 9090 with debug"
  echo ""
  echo -e "${GREEN}Options:${NC}"
  echo "  --port, -p PORT   Specify port (default: 8080)"
  echo "  --debug, -d       Enable debug logging"
  echo "  --help, -h        Show this help"
  echo ""
  echo -e "${GREEN}Environment Variables:${NC}"
  echo "  DEV_PORT          Override default port"
  echo ""
  echo -e "${YELLOW}Note:${NC} This is equivalent to './mvnw quarkus:dev' but faster to type!"
  exit 0
fi

# Validate port
if ! [[ "$PORT" =~ ^[0-9]+$ ]] || [ "$PORT" -lt 1024 ] || [ "$PORT" -gt 65535 ]; then
  echo -e "${RED}‚ùå Error: Port must be a number between 1024 and 65535${NC}"
  exit 1
fi

# Check if port is in use
if command -v lsof >/dev/null 2>&1; then
  if lsof -Pi :$PORT -sTCP:LISTEN -t >/dev/null 2>&1; then
    echo -e "${YELLOW}‚ö†Ô∏è  Warning: Port $PORT is already in use${NC}"
    echo "   You can check what's using it with: lsof -i :$PORT"
    echo ""
  fi
fi

# Set environment variables
export DEV_PORT=$PORT

if [ "$DEBUG_MODE" = true ]; then
  export QUARKUS_LOG_LEVEL=DEBUG
  export QUARKUS_LOG_CATEGORY_COM_EXAMPLE_TRANSACTIONS_LEVEL=DEBUG
fi

# Show startup info
echo -e "${BLUE}üöÄ Starting Quarkus Development Server${NC}"
echo -e "${GREEN}üìç Port:${NC} $PORT"
echo -e "${GREEN}üåê URL:${NC} http://localhost:$PORT"
echo -e "${GREEN}üìö Docs:${NC} http://localhost:$PORT/q/swagger-ui"
echo -e "${GREEN}‚ù§Ô∏è  Health:${NC} http://localhost:$PORT/q/health"

if [ "$DEBUG_MODE" = true ]; then
  echo -e "${YELLOW}üêõ Debug mode enabled${NC}"
fi

echo ""
echo -e "${YELLOW}üí° Pro tip: Press 'w' in the Quarkus console to open in browser${NC}"
echo ""

# Start Quarkus
exec ./mvnw quarkus:dev
